#!/usr/bin/env python3
"""
–ì–ª–∞–≤–Ω—ã–π CLI-—Å–∫—Ä–∏–ø—Ç Coding Agent.
–ó–∞–ø—É—Å–∫: python coding_agent.py --issue 1 --repo –≤–∞—à_–ª–æ–≥–∏–Ω/—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
"""
import argparse
import sys
import os
import time
import json
from datetime import datetime

# ==================== 1. –ó–ê–ì–†–£–ó–ö–ê –ò –ü–†–û–í–ï–†–ö–ê –¢–û–ö–ï–ù–û–í ====================
# –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–º–µ–Ω –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
GITHUB_TOKEN = os.getenv("GH_PAT") or os.getenv("GITHUB_PAT") or os.getenv("GITHUB_TOKEN")
DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY") or os.getenv("DEEPSEEK_KEY")

if not GITHUB_TOKEN:
    print("‚ùå –û—à–∏–±–∫–∞: GitHub token not found")
    print("   –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:")
    for var in ["GH_PAT", "GITHUB_PAT", "GITHUB_TOKEN"]:
        print(f"   - {var}: {'–µ—Å—Ç—å' if os.getenv(var) else '–Ω–µ—Ç'}")
    sys.exit(1)

if not DEEPSEEK_API_KEY:
    print("‚ùå –û—à–∏–±–∫–∞: DeepSeek API key not found")
    print("   –î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ:")
    for var in ["DEEPSEEK_API_KEY", "DEEPSEEK_KEY"]:
        print(f"   - {var}: {'–µ—Å—Ç—å' if os.getenv(var) else '–Ω–µ—Ç'}")
    sys.exit(1)

print("‚úÖ –¢–æ–∫–µ–Ω—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã:")
print(f"   GitHub: {'*' * 8}{GITHUB_TOKEN[-4:] if len(GITHUB_TOKEN) > 8 else ''}")
print(f"   DeepSeek: {'*' * 8}{DEEPSEEK_API_KEY[-4:] if len(DEEPSEEK_API_KEY) > 8 else ''}")

# ==================== 2. –ù–ê–°–¢–†–û–ô–ö–ê –ü–£–¢–ï–ô –ò –ò–ú–ü–û–†–¢–û–í ====================
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

try:
    from core.github_client import (
        get_issue_content,
        create_branch,
        apply_code_changes,
        create_pull_request,
        get_latest_ai_review_verdict,
        get_repo_files,
        test_github_connection
    )
    from core.llm_service import analyze_issue_with_llm, generate_code_changes
    print("‚úÖ –ú–æ–¥—É–ª–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
except ImportError as e:
    print(f"‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: {e}")
    print("   –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –µ—Å—Ç—å –ø–∞–ø–∫–∞ 'core' —Å —Ñ–∞–π–ª–∞–º–∏:")
    print("   - core/github_client.py")
    print("   - core/llm_service.py")
    sys.exit(1)

# ==================== 3. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
def prepare_files_from_llm_response(llm_response, attempt_number):
    """–ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ –æ—Ç–≤–µ—Ç–∞ LLM."""
    files_to_change = {}
    changes = llm_response.get("changes", [])
    
    if not changes:
        print("‚ö†Ô∏è LLM –Ω–µ –ø—Ä–µ–¥–ª–æ–∂–∏–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π. –ò—Å–ø–æ–ª—å–∑—É—é —à–∞–±–ª–æ–Ω...")
        files_to_change = {
            f"generated_{attempt_number}.py": f"""# –ü–æ–ø—ã—Ç–∫–∞ {attempt_number}
# Generated by Coding Agent

def solution():
    \"\"\"–†–µ—à–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω–æ–µ Coding Agent.\"\"\"
    return "Hello from Coding Agent!"

if __name__ == "__main__":
    print(solution())
"""
        }
    else:
        for change in changes:
            file_path = change.get("file_path", f"generated_{attempt_number}.py")
            new_content = change.get("new_content", "# –§–∞–π–ª —Å–æ–∑–¥–∞–Ω –∞–≥–µ–Ω—Ç–æ–º")
            files_to_change[file_path] = new_content
    
    return files_to_change

def create_issue_comment(repo_full_name, issue_number, message):
    """–°–æ–∑–¥–∞–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Issue."""
    try:
        from github import Github
        github_client = Github(GITHUB_TOKEN)
        repo = github_client.get_repo(repo_full_name)
        issue = repo.get_issue(number=issue_number)
        issue.create_comment(message)
        print(f"üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω –∫ Issue #{issue_number}")
    except Exception as e:
        print(f"‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: {e}")

# ==================== 4. –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê –ê–ì–ï–ù–¢–ê ====================
def main(issue_number, repo_full_name):
    print(f"\nüöÄ –ó–∞–ø—É—Å–∫ Coding Agent –¥–ª—è Issue #{issue_number} –≤ {repo_full_name}")
    print("=" * 50)

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ GitHub
    print("üîó –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ GitHub...")
    if not test_github_connection():
        print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ GitHub")
        return None

    MAX_ATTEMPTS = 2  # –£–º–µ–Ω—å—à–∏–º –¥–ª—è —Ç–µ—Å—Ç–∞
    current_attempt = 1
    pr_url = None
    branch_name = f"coding-agent/issue-{issue_number}"

    try:
        # 1. –ü–æ–ª—É—á–∞–µ–º –∑–∞–¥–∞—á—É –∏–∑ Issue
        print("üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏ –∏–∑ GitHub...")
        issue_title, issue_body = get_issue_content(repo_full_name, issue_number)
        print(f"   –ó–∞–≥–æ–ª–æ–≤–æ–∫: {issue_title}")
        print(f"   –û–ø–∏—Å–∞–Ω–∏–µ: {issue_body[:200]}...")

        # 2. –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        print("üìÅ –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è...")
        repo_files = get_repo_files(repo_full_name)
        if repo_files:
            print(f"   –ù–∞–π–¥–µ–Ω–æ —Ñ–∞–π–ª–æ–≤: {len(repo_files)}")

        while current_attempt <= MAX_ATTEMPTS:
            print(f"\nüîÑ –ü–û–ü–´–¢–ö–ê {current_attempt}/{MAX_ATTEMPTS}")
            print("-" * 40)

            if current_attempt > 1:
                print("üëÄ –ñ–¥—É –≤–µ—Ä–¥–∏–∫—Ç –æ—Ç AI Reviewer...")
                time.sleep(5)

            # 3. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∑–∞–¥–∞—á—É —Å –ø–æ–º–æ—â—å—é LLM
            print("üß† –ê–Ω–∞–ª–∏–∑ –∑–∞–¥–∞—á–∏ —Å –ø–æ–º–æ—â—å—é AI...")
            analysis = analyze_issue_with_llm(issue_title, issue_body, repo_files)
            
            # 4. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥
            print("üíª –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞...")
            llm_response = generate_code_changes(issue_body, analysis)
            
            print(f"üìù –ü–ª–∞–Ω: {llm_response.get('summary', '–ü–ª–∞–Ω –Ω–µ —É–∫–∞–∑–∞–Ω')}")
            
            # 5. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è
            files_to_change = prepare_files_from_llm_response(llm_response, current_attempt)
            print(f"üìÑ –§–∞–π–ª–æ–≤ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è: {len(files_to_change)}")
            for file_path in files_to_change.keys():
                print(f"   - {file_path}")

            # 6. –°–æ–∑–¥–∞—ë–º/–æ–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ç–∫—É –∏ PR
            commit_message = f"Fix Issue #{issue_number} (attempt {current_attempt}): {issue_title[:50]}..."

            if current_attempt == 1:
                # –ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞: —Å–æ–∑–¥–∞—ë–º –Ω–æ–≤—É—é –≤–µ—Ç–∫—É –∏ PR
                print(f"üå≥ –°–æ–∑–¥–∞—é –≤–µ—Ç–∫—É '{branch_name}'...")
                create_branch(repo_full_name, branch_name)

                print(f"üìù –ü—Ä–∏–º–µ–Ω—è—é –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –≤–µ—Ç–∫—É...")
                apply_code_changes(repo_full_name, branch_name, files_to_change, commit_message)

                print(f"üîó –°–æ–∑–¥–∞—é Pull Request...")
                pr_url = create_pull_request(repo_full_name, branch_name, issue_title, issue_number)
                if pr_url:
                    print(f"‚úÖ PR —Å–æ–∑–¥–∞–Ω: {pr_url}")
                else:
                    print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å PR")
                    break
            else:
                # –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –ø–æ–ø—ã—Ç–∫–∏: –æ–±–Ω–æ–≤–ª—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR
                print(f"‚úèÔ∏è –û–±–Ω–æ–≤–ª—è—é —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π PR (–ø–æ–ø—ã—Ç–∫–∞ {current_attempt})...")
                apply_code_changes(repo_full_name, branch_name, files_to_change, commit_message)
                print(f"‚úÖ –ö–æ–¥ –æ–±–Ω–æ–≤–ª—ë–Ω –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º PR: {pr_url}")

            # 7. –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–æ–º–µ—Ä PR –∏–∑ URL
            pr_number = None
            if pr_url:
                try:
                    pr_number = int(pr_url.split("/")[-1])
                except:
                    pass

            # 8. –ñ–¥–µ–º –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–¥–∏–∫—Ç Reviewer
            if current_attempt == 1:
                print("\n‚è≥ –ñ–¥—É –∑–∞–ø—É—Å–∫ AI Reviewer... (30 —Å–µ–∫)")
                time.sleep(30)

            if pr_number:
                # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä–¥–∏–∫—Ç Reviewer
                print("ü§ñ –ü—Ä–æ–≤–µ—Ä—è—é –≤–µ—Ä–¥–∏–∫—Ç AI Reviewer...")
                verdict = get_latest_ai_review_verdict(repo_full_name, pr_number)

                print(f"   –í–µ—Ä–¥–∏–∫—Ç AI Reviewer: {verdict}")

                if verdict == "APPROVE":
                    print("=" * 50)
                    print(f"üéâ –£–°–ü–ï–•! –ó–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞ —Å {current_attempt} –ø–æ–ø—ã—Ç–∫–∏.")
                    print(f"üîó Pull Request: {pr_url}")
                    
                    # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Issue
                    success_message = f"""
## üéâ –ó–∞–¥–∞—á–∞ —Ä–µ—à–µ–Ω–∞!

**Issue #{issue_number} —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞ Coding Agent.**

‚úÖ –†–µ—à–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ AI Reviewer
‚úÖ PR —Å–æ–∑–¥–∞–Ω: {pr_url}
‚úÖ –ü–æ—Ç—Ä–µ–±–æ–≤–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: {current_attempt}

*–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ SDLC –∑–∞–≤–µ—Ä—à–∏–ª–∞ —Ä–∞–±–æ—Ç—É —É—Å–ø–µ—à–Ω–æ.*
"""
                    create_issue_comment(repo_full_name, issue_number, success_message)
                    
                    return pr_url
                elif verdict == "REQUEST_CHANGES":
                    print("‚ö†Ô∏è AI Reviewer –∑–∞–ø—Ä–æ—Å–∏–ª –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è. –ì–æ—Ç–æ–≤–ª—é –Ω–æ–≤—É—é –ø–æ–ø—ã—Ç–∫—É...")
                    current_attempt += 1
                    continue
                else:
                    print(f"‚è≥ AI Reviewer: {verdict}. –ñ–¥—É... (20 —Å–µ–∫)")
                    time.sleep(20)
                    continue
            else:
                print("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –Ω–æ–º–µ—Ä PR")
                break

            current_attempt += 1

        # –ï—Å–ª–∏ –≤—ã—à–ª–∏ –∏–∑ —Ü–∏–∫–ª–∞ (–≤—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –∏—Å—á–µ—Ä–ø–∞–Ω—ã)
        print("=" * 50)
        print(f"üö® –î–û–°–¢–ò–ì–ù–£–¢ –õ–ò–ú–ò–¢ –ü–û–ü–´–¢–û–ö ({MAX_ATTEMPTS})")
        print(f"üîó –ü–æ—Å–ª–µ–¥–Ω–∏–π PR: {pr_url}")

        # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –≤ Issue
        failure_message = f"""
## ‚ö†Ô∏è Coding Agent –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω

–î–æ—Å—Ç–∏–≥–Ω—É—Ç –ª–∏–º–∏—Ç –≤ {MAX_ATTEMPTS} –ø–æ–ø—ã—Ç–æ–∫.

**–ü–æ—Å–ª–µ–¥–Ω–∏–π —Å—Ç–∞—Ç—É—Å:**
- Issue: #{issue_number}
- –ü–æ—Å–ª–µ–¥–Ω–∏–π PR: {pr_url or '–Ω–µ —Å–æ–∑–¥–∞–Ω'}
- –ü–æ–ø—ã—Ç–æ–∫: {current_attempt-1}

*–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–¥–∞—á—É –≤—Ä—É—á–Ω—É—é.*
"""
        create_issue_comment(repo_full_name, issue_number, failure_message)

        return pr_url

    except Exception as e:
        print(f"\nüí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞:")
        print(f"   –¢–∏–ø: {type(e).__name__}")
        print(f"   –°–æ–æ–±—â–µ–Ω–∏–µ: {e}")
        
        # –û—Å—Ç–∞–≤–ª—è–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –æ–± –æ—à–∏–±–∫–µ
        error_message = f"""
## üí• –û—à–∏–±–∫–∞ Coding Agent

–ü—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ Issue #{issue_number} –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞:

*–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ GitHub Actions.*
"""
        create_issue_comment(repo_full_name, issue_number, error_message)
        
        raise

# ==================== 5. CLI –ò–ù–¢–ï–†–§–ï–ô–° ====================
if __name__ == "__main__":
    parser = argparse.ArgumentParser(
        description='Coding Agent: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞—ë—Ç Pull Request –¥–ª—è GitHub Issues',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è:
  python coding_agent.py --issue 1 --repo username/test-repo
  python coding_agent.py --issue 5 --repo organization/project

–¢—Ä–µ–±—É–µ–º—ã–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ GitHub:
  - GH_PAT: GitHub Personal Access Token
  - DEEPSEEK_KEY: DeepSeek API Key
        """
    )

    parser.add_argument(
        '--issue',
        type=int,
        required=True,
        help='–ù–æ–º–µ—Ä Issue –≤ GitHub'
    )

    parser.add_argument(
        '--repo',
        type=str,
        required=True,
        help='–†–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –≤ —Ñ–æ—Ä–º–∞—Ç–µ "–≤–ª–∞–¥–µ–ª–µ—Ü/–Ω–∞–∑–≤–∞–Ω–∏–µ"'
    )

    parser.add_argument(
        '--test',
        action='store_true',
        help='–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º (—Ç–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑ –±–µ–∑ —Å–æ–∑–¥–∞–Ω–∏—è PR)'
    )

    args = parser.parse_args()

    if args.test:
        print("üß™ –¢–ï–°–¢–û–í–´–ô –†–ï–ñ–ò–ú")
        print(f"   Issue: #{args.issue}")
        print(f"   Repo: {args.repo}")
        
        try:
            # –¢–æ–ª—å–∫–æ –∞–Ω–∞–ª–∏–∑
            issue_title, issue_body = get_issue_content(args.repo, args.issue)
            print(f"‚úÖ Issue –ø–æ–ª—É—á–µ–Ω–∞: {issue_title}")
            
            analysis = analyze_issue_with_llm(issue_title, issue_body)
            print(f"\n‚úÖ –ê–Ω–∞–ª–∏–∑ –∑–∞–≤–µ—Ä—à–µ–Ω")
            print(f"   –°–ª–æ–∂–Ω–æ—Å—Ç—å: {analysis.get('estimated_complexity', 'unknown')}")
            print(f"   –§–∞–π–ª–æ–≤ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è: {len(analysis.get('files_to_create', []))}")
            
            if analysis.get('files_to_create'):
                print("   –§–∞–π–ª—ã:")
                for file in analysis['files_to_create'][:3]:
                    print(f"     - {file}")
        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
            import traceback
            traceback.print_exc()
    else:
        # –ó–∞–ø—É—Å–∫–∞–µ–º –≥–ª–∞–≤–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é
        result = main(args.issue, args.repo)
        
        if result:
            print(f"\n‚úÖ Coding Agent –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É")
            print(f"   –†–µ–∑—É–ª—å—Ç–∞—Ç: {result}")
            sys.exit(0)
        else:
            print(f"\n‚ùå Coding Agent –∑–∞–≤–µ—Ä—à–∏–ª —Ä–∞–±–æ—Ç—É —Å –æ—à–∏–±–∫–æ–π")
            sys.exit(1)
